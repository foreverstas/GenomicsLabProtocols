---
title: "Docker"
author: "Romanov Stanislav"
date: "09 12 2021"
output: html_document
lang: russian
tags: ["Docker", "Программы"]
editor_options: 
  markdown: 
    wrap: 72
---

### Для чего нужен Docker?

Раньше разработчики биоинформатических алгоритмов предоставляли свои
продукты в виде готовых программ, импортируемых библиотек, отдельных
скриптов. Однако со временем стабильность работы программ стала слишком
зависеть от версии операционной системы и установленных на компьютере
зависимостей. В результате, зачастую наиболее распространенные
биоинформатические алгоритмы доступны только пользователям одной
операционной системы (тот же `bowtie2` отсутствует на Windows). Чтобы
решить эту проблему, некоторые разработчики стали предоставлять
приложения в форме контейнеров *(conteiners)* - полностью изолированных
от операционной системы самодостаточных наборов программ, включающие
полный каталог скриптов и все зависимости.

Разработчики приложения упаковывают в контейнер все необходимые компоненты операционной системы, и проверяют зависимости на совместимость, благодаря чему приложение из контейнера будет работать без ошибок на любой операционной системе. Запуск приложения в
контейнере означает, что программа никак не зависит от окружающих
процессов и операционной системы, в которой запущен контейнер. Самым
распространенным менеджером контейнеров является Docker. С его помощью
на ОС Windows можно запускать такие программы как `bowtie2`, `hisat2`,
`higlass` и любые другие программы, которые были написаны специально под
Linux или любую другую ОС. Вообще, разработчики все чаще предоставляют
свои программы именно в форме docker-контейнеров, поэтому всем
заинтересованным в биоинофрматике необходимо иметь хотя бы минимальные
навыки работы с Docker.

{{% expand "Пояснения" %}}

{{% notice "note" %}}
Например, разработчики создают приложение в системе разработки (например, Ubuntu) — там все настроено, приложение работает. Когда приложение готово, его нужно перенести в систему тестирования, а затем в продуктивную среду (например, macOS или Windows). Если в одной из сред нет нужной зависимости, приложение не будет работать. Программистам придется отвлечься от разработки и совместно с командой поддержки разобраться в ситуации. В контейнерах такой проблемы нет, так как они содержат в себе все необходимое для запуска приложения. Специалисты занимаются разработкой, а не решением инфраструктурных проблем.
{{% /notice %}}
{{% notice "note" %}}
На машине может быть запущено одновременно несколько контейнеров, при этом каждый контейнер будет занимать только строго определенную часть процессорной мощности.
{{% /notice %}}
{{% notice "note" %}}
По сути, контейнер является директорией, внутри которой хранятся все нужные для программы файлы и внутри которой производятся все процессы. После запуска контейнера файлы из операционной системы можно перекидывать внутрь контейнера в реальном времени.
{{% /notice %}}
{{% notice "note" %}}
Контейнеризация позволяет избежать проблем совместимости между операционными системами. Для того, чтобы запустить приложение под Linux на операционной системе Windows раньше приходилось устанавливать виртуальную машину, выделять под нее сектор на диске, искать в интернете образ операционной системы. Это было долго и требовало очень много вычислительных ресурсов. Контейнеры содержат только необходимые компоненты операционной системы и все исходные файлы предоставляются разработчиком, а загрузка контейнера происходит одной командой.
{{% /notice %}}

{{% /expand %}}

### Как контейнеры попадают на компьютер?

Для того, чтобы запустить контейнер, docker требуется скачать все необходимые файлы. Исходные файлы организованы в виде так называемых образов. *Образ (image)* является пакетом данных, который содержит нужное для запуска контейнера программное обеспечение.

{{% notice "note" %}}
Образ - это неизменяемый файл, содержащий исходный код, библиотеки, зависимости, инструменты и другие файлы, необходимые для запуска приложения в контейнере. Из-за того, что образы предназначены только для чтения их иногда называют снимками *(snapshot)*. Образ используется как шаблон для построения контейнера. При создании контейнера поверх образа добавляет слой, доступный для записи, что позволяет менять его по своему усмотрению.
{{% /notice %}}

Перед запуском контейнера docker должен скачать образ. В зависимости от программы размер образа может сильно отличаться (от нескольких мегабайт до десятков гигабайт). Скаченный образ будет храниться в файловой системе компьютера и будет использоваться при каждом запуске контейнера. Если вы удалите контейнер, то образ останется в системе. Однако, если вы запустили контейнер и сделали в нем какие-то изменения (добавили новые файлы, например), то внутри образа никаких изменений не будет. Так что при новом запуске контейнера все изменения будут утеряны, программа будет работать “с нуля”.

Пользователь может создавать образы самостоятельно либо получать их из репозитория [Docker Hub](https://hub.docker.com/). Удобно то, что пользователю docker не обязательно скачивать образ перед запуском контейнера. Команда `docker run`, которая запускает контейнер, при каждом вызове будет искать нужный образ в системе, и если такой отсутствует, то скачает его из хаба самостоятельно.

### Установка Docker Desktop

Сторонние руководства по установке можно найти по ссылкам ниже:

{{% expand "Полезные ссылки" %}}

[Документация по установке и системные
требования](https://docs.docker.com/desktop/install/windows-install/)

[Видео пример установки с
Hyper-V](https://www.youtube.com/watch?v=a5mxBTGfC5k)

[Инструкция по
установке на Windows с
WSL2](https://tretyakov.net/post/ustanovit-docker-na-windows-10-wsl2/)

[Еще одна инструкция по установке на Windows с
WSL2](https://ip-calculator.ru/blog/ask/ustanovka-docker-na-windows-10-home/)

{{% /expand %}}
Установка Docker Desktop происходит в несколько этапов.

1.  В **BIOS** включить виртуализацию. Для этого нужно перезагрузить
    компьютер, войти в BIOS, затем в одном из окон найти строчку,
    которая включает слова Virtualization (Intel Virtualization
    Technology, VT, Virtualization и пр.) и Hyper-V. Затем перевести в
    режим Enabled.

![Куда смотреть в BIOS?](/Programs/Docker.files/bios.png?width=20pc)

2.  Скачать установщик **Docker Desktop** на сайте
    [docker.com](https://www.docker.com/). Во время установки следовать
    инструкциям.

![Официальный сайт](/Programs/Docker.files/docker.png?width=20pc)

Если все работает, то после установки вы должны увидеть вот такое окно:

![Когда все нормально](/Programs/Docker.files/Normal.png?width=20pc)

Но программа может выдать ошибки из-за неполной установки зависимостей.
В таком случае будут видны такие ошибки:

![WSL2 is not installed](/Programs/Docker.files/noWSL.png?width=20pc)

![WSL2 installation is incomplete](/Programs/Docker.files/incomplete.png?width=20pc)

Вообще в сообщении об ошибке уже написано, что делать, но если есть
затруднения, то нужно сделать как указано ниже.

{{% expand "   Видео-помощь" %}}

[WSL2 installation is incomplete](https://www.youtube.com/watch?v=SjdFip4t3kI)

[WSL2 is not installed](https://www.youtube.com/watch?v=vJ2fJm3CoyE)

{{% /expand %}}

Решением будет установка подсистемы Linux для Windows, как это описано в
руководстве [здесь](https://learn.microsoft.com/ru-ru/windows/wsl/install) и
[здесь](https://learn.microsoft.com/ru-ru/windows/wsl/install-manual).
На первый взгляд это кажется очень сложным, но на самом деле потребует
только несколько раз войти в **PowerShell** и **MicrosoftStore**.

{{% expand "Как открыть PowerShell" %}}

{{% notice "note" %}}
Чтобы войти в **PowerShell** нужно нажать Пуск и в строке поиска ввести *«PowerShell»*. Появившийся ярлык нажать правой кнопкой и выбрать опцию *«Запустить от имени администратора»*
{{% /notice %}}

![Поиск в меню Пуск](/Programs/Docker.files/powershell.jpg?width=20pc)

{{% /expand %}}

Далее нажать *Пуск* и в строке поиска ввести *«Дополнительные компоненты»*. В появившемся окне выбрать *«Другие компоненты Windows»*. Далее поставить галочки напротив *«Платформа виртуальной машины»* и *«Подсистема Linux для Windows»*.

{{% expand "Как найти Другие компоненты Windows" %}}

![Поиск в меню Пуск](/Programs/Docker.files/additional.png?width=20pc&classes=inline)
![Дополнительные компоненты](/Programs/Docker.files/others.png?width=20pc&classes=inline)
![Другие компоненты Windows](/Programs/Docker.files/components.png?width=20pc&classes=inline)

{{% /expand %}}

### Пример работы с Docker и Docker Desktop

Для быстрого знакомства создатели docker разработали контейнер getting-started. Правильный запуск контейнера сделает возможным просмотр ознакомительной документации через HTML-страницы в браузере. По сути, после запуска этого контейнера, у вас появится ссылка на статический вебсайт, на который вы сможете зайти через браузер. Ниже показана последовательность действий, которая позволит запустить этот контейнер.

1.  Зайти в `PowerShell` или `CommandLine`

{{% expand "Способ 1" %}}

Нажать комбинацию клавиш Windows+R и в появившемся окне ввести
*powershell* или *cmd*, соответственно.

{{% /expand %}}

{{% expand "Способ 2" %}}

Нажать клавишу Windows или кнопку Пуск на рабочем столе и в появившейся
строке поиска ввести *powershell* или *Командная строка*,
соответственно. Открыть приложение.

{{% /expand %}}

2.  Cкачать образ контейнера с помощью `docker pull`

В появившемся окне консоли ввести команду:


    > docker pull docker/getting-started

Эту команда написана в документации образа [docker/getting-started](https://hub.docker.com/r/docker/getting-started) в правой части экрана.

В результате в окне приложения Docker Desktop в разделе images появится
информация о скачанном образе. В данном случае это
`docker/getting-started`. Нужно обратить внимание, что название образа
совпадает с названием, которое было введен в команде выше.

![Image](/Programs/Docker.files/image.png?width=20pc)

Скачав образ один раз, с него можно запустить несколько одинаковых контейнеров.

{{% notice "note" %}}
Не обязательно заранее скачивать образ. Если вы запускаете контейнер впервые (см. пункт ниже), то Docker самостоятельно скачает нужный образ и сразу запустит контейнер.
{{% /notice %}}

3.  Запустить контейнер.

Запустить контейнер можно через консоль (при помощи команды `docker run`) либо при помощи кнопки Run в окне Images. Во время запуска нужно будет заставить docker связать контейнер с IP-адресом. Это позволит контейнеру вывести результат работы программы в браузер.

{{% expand "Запуск через консоль" %}}
В консоли ввести:


    > docker run -d -p 80:80 docker/getting-started

Эта команда написана в документации образа [docker/getting-started](https://hub.docker.com/r/docker/getting-started).
Обычно нет нужды переписывать или модифицировать ее. В ответ docker запустит сам контейнер. Либо сначала скачает образ (если это не было сделано ранее) и сразу скачает контейнер.

{{% /expand %}}

{{% expand "Запуск через Docker Desktop" %}}

В **Docker Desktop** зайти в раздел `Images` и нажать на кнопку Run справа от названия образа.

![ImageRun](/Programs/Docker.files/imagerun.png?width=20pc)

В сплывающем окне `Optional parameters` нужно обазятельно вести число 80 ячейку `Ports`. Только после этого вы сможете обратиться к контейнеру через браузер.

{{% /expand %}}

В разделе `Container` появится название контейнера. В данном случае это
`condescending_bhaskara`. Само название может отличаться от названия
образа, поскольку мы его не задавали изначально.

{{% notice "note" %}}
По умолчанию docker дает контейнерам названия из двух слов, разделенных нижним подчеркиванием. Первое слово - это случайное прилагательное, а второе слово - имя известного ученого.
{{% /notice %}}

Кроме того, у контейнера есть *индентификатор*. В данном случае это “f5a36b69f508”. Это кодовое название контейнера, которое может быть использовано в служебных командах docker.
Есть еще параметр `port`, к которому мы обратимся позже.

![Container](/Programs/Docker.files/container.png?width=20pc)

Запущеный таким образом контейнер содержит программу, к которой мы можем обратиться при помощи браузера. Самый простой способ сделать это - нажать на троеточие напротив названия контейнера и в сплывающем окне вырбрать `Open with browser`. Либо можно открыть на компьютере браузер и ввести в адресную строку `localhost:80` или, что то же самое,
`http://localhost:80`. Нужно понимать, что параметр `Open with browser` и ссылка в браузере заработают только при правильной настройке контейнера.

![Container](/Programs/Docker.files/program.png?width=20pc)

Обратите внимание, что после того, как вы введете нужный адрес в адресную строку браузера, адрес поменяется в соответствием с URL-адресами, запрограммированными внутри контейнера.

### Настройки контейнеров перед и после запуска

Как было показано, запуск контейнера производится при помощи команды `docker run`.

Синтаксис команды следующий:


    > docker run [Параметры] название_образа [название_программы] [аргументы...]

Необходимо внимательно следить за порядком написания отдельных частей команды. Параметры команды `docker run` должны быть написаны перед названием образа. После образа можно писать название программы, результат которой вы хотите получить. После названия программы должны идти соответсвующие аргументы.

#### Как дать контейнеру название?

Параметр `--name` позволит присвоить контейнеру нужное имя. Например, после команды


    > docker run --name StaticSite -d -p 80:80 docker/getting-started

название контейнера будет “StaticSite” и можно будет использовать это название при обращении к контейнеру другими командами docker.

#### Как найти все запущеные контейнеры и их параметры?

Команда


    > docker ps

предоставить таблицу со списком всех установленных контейнеров. Ту же самую информацию можно увидеть в разделе **Containers** программы **Docker Desktop**. Дополнительные подробности можно рассмотреть в разделе **Inspect**, куда можно попасть если нажать на название контейнера.

#### Настройка доступа к контейнеру через браузер

Зачастую Docker используется для запуска на комьютере сервера. Как было показано выше, после включения контейнера docker/getting-started на компьютере запускается статичный HTML-сервер, к которому можно обращаться всегда, пока запущен контейнер. Правильная настройка доступа к серверу может быть проблематичной, если не понимать, как это работает (что затруднительно, особенно если не иметь представления о компьютерных сетях).

При запуске контейнера был указан параметр `-p 80:80`. Этот параметр заставляет привязать контейнер к IP-адресу локальной машины. А значит, чтобы открыть сайт, нам нужно ввести адрес на локальной машине.

Чтобы узнать, по какому адресу располагается сервер, который мы сейчас запустили, нужно обратить внимание на параметр `port`, который можно подробно рассмотреть в разделе **Inspect**, куда можно попасть если нажать на название контейнера.

![Container](/Programs/Docker.files/port.png?width=20pc)

Как альтернатива, можно ввести в **PowerShell** или **cmd** команду

    > docker ps

В таком случае в консоли появится следующая таблица:

| CONTAINER ID | IMAGE                  | COMMAND                | CREATED       | STATUS       | PORTS               | NAMES                  |
|--------------|------------------------|------------------------|---------------|--------------|---------------------|------------------------|
| f5a36b69f508 | docker/getting-started | “/docker-entrypoint….” | 2 minutes ago | Up 5 seconds | 0.0.0.0:80-\>80/tcp | condescending_bhaskara |

Легко заметить, что информация в этой таблице почти полностью отображена в разделе **Inspect**. Здесь мы снова видим название контейнера, название образа, время создания, а также адрес порта.

Если мы знаем название контейнера, мы можем быстро узнать порт при помощи команды PowerShell


    > docker port название_контейнера

Данные в ячейке `PORTS` позволяют понять, как можно обращаться к серверу через
браузер. В данном случае для нашего контейнера port обозначен как
`0.0.0.0:80 ->80/tcp`. Строка 0.0.0.0 перед двоеточием - это IP-адрес,
по которому браузер будет искать запущеную нами программу. В
компьютерных сетях этим адресом обозначают все возможные IP-адреса,
закрепленные за локальной машиной `localhost`, то есть закрепленные за
компьютером, на котором запущен docker. Число 80 после двоеточия
означает, что чтобы найти данные, принадлежащие именно запущеному на
локальной машине контейнеру, браузер должен будет искать пакеты данных с
индексом 80. Это так называемый *порт контейнера*.

Фрагмент `->80/tcp` говорит о том, что браузер будет общаться с программой по протоколу TCP/IP через tcp-порт хоста c номером 80. Выбор порта и протокола передачи данных зависит от структуры сети и типа сервера, который запрограммирован в контейнере. В данном случае указан порт хоста 80, поскольку сервер передает HTML-страницы. Почтовые сервера обычно связываются с портом 25 или 110 и общаются по протоколу SMTP. Но вообще, это важно только для программистов. Поэтому, чтобы ничего не ломать, я предлагаю писать в параметре `-p` только тот адрес и протокол, которые упоминаются в документации к контейнеру.

Почему после запуска программы появился именно такой IP-адрес? В команде `docker run` мы вводили параметр `-p 80:80`. Перед двойточием указан порт контейнера, после двоеточия
указан tcp-порт локальной машины под номером 80, по которому
осуществляется передача данных по протоколу TCP/IP. Если команда
выглядит “-p 8989:80”, то порт контейнера равен 8989, страницу нужно
искать по IP-адресу локальной машины *localhost*, а передача данных будет
производиться по протоколу TCP/IP. В таком случае, чтобы вызвать программу из
браузера, нужно ввести адрес `localhost:8989`.

В [документации docker](https://docs.docker.com/network/links/) есть много других примеров, как можно привязать контейнер к IP-адресам. Например, в команде `-p 8989:80` мы не пишем конкретный IP-адрес, к которому будет привязан контейнер, поэтому docker по умолчанию использует адрес 0.0.0.0. Но так как это общее название для всех адресов на локальной машине, мы не знаем, к какому IP-адресу локальной машины все-таки будет привязан контейнер. Если docker принимает в качестве IP-адреса 0.0.0.0, то к контейнеру смогут подключиться пользователи на всех сетевых интерфейсах (как публичных, так и частных), что обычно считается небезопасным. Чтобы попасть на созданный нами сервер, мы должны вписать в адресной строке “localhost:8989”. В то же время, обращение `8989:80` является сокращенной формой, и полностью команда выглядит как `-p 0.0.0.0:8989:80/tcp`. Зная это, мы можем менять IP-адрес, порт контейнера, порт локальной машины, а также протокол передачи данных. Например, ввод `-p 127.0.0.1:8000:80/tcp` заставит docker привязать контейнер к адресу `http:/127.0.0.1:8000`.

#### Как приостановить и запустить снова выполнение контейнера?

Остановить запущеный контейнер можно из окна docker в разделе `Containers`, нажатием на значок **Stop** (серый квадратик) напротив названия контейнера. Либо нужно в `PowerShell` ввести команду:


    > docker stop название_контейнера

Обратите внимание, что здесь нужно вводить не название образа, а название контейнера.

При остановке контейнера все данные и временные файлы внутри контейнера будут сохранены до следующего запуска.

Чтобы заново запустить выполнение контейнера нужно нажать на значок **Start** (серый треугольник) напротив остановленного контейнера. Либо нужно в `PowerShell` ввести команду:


    > docker restart название_контейнера

#### Режимы запуска контейнеров

При запуске контейнера Docker при помощи `docker run` в терминале вы должны сначала решить, хотите ли вы запускать контейнер в фоновом режиме (*detached mode*) или на переднем плане (*foreground mode*).

-   Фоновый режим

В примере выше мы запускали статический вебсайт следующим образом:


    > docker run -d -p 80:80 docker/getting-started

А сразу после ввода команды терминал выводил идентификатор образа и приглашал ввести слудующую команду:


    > docker run -d -p 80:80 docker/getting-started

    0e1d96e727a0d5b855b559689a91ca6e0bcf7149ce2492fa4525935336133950

    >

Даже после закрытия терминала контейнер продолжает работать, и статический вебсайт остается доступен до тех пор, пока контейнер не будет остановлен. Это так называемый режим *Detach*, или фоновый режим.

В режиме Detach, после ввода команды `docker run ...` в терминале, Docker запустит программу внутри контейнера в фоновом режиме и вы сможете вводить другие команды оболочки Windows в терминал. В таком случае можно будет спокойно закрыть терминал, а контейнер продолжит работу. Контейнеры, запущенные в фоновом режиме, останавливаются, когда завершается корневой процесс, используемый для запуска контейнера.

Запустить фоновый режим можно с помощью параметра `-d` или `--detach`, или `-d=true` (это одно и то же). В примере выше мы именно его и вводили. Если вы укажете вместе с параметром `-d` еще параметр `--rm`, то после выхода из контейнера или закрытия Docker контейнер будет полностью удален.

-   Передний план

В примере выше мы запускали контейнер `docker/getting-started` с параметром `-d` в фоновом режиме, что делало возможным пользоваться терминалом после открытия контейнера. Если убрать этот параметр, то в окно консоли начнут выводиться журнал сообщений (*logs, логи*) контейнера.

    > docker run -p 80:80 docker/getting-started

    /docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration
    ...[много всего остального]...
    2022/10/13 12:08:41 [notice] 1#1: start worker process 39

Теперь, требуется открыть новое окно терминала, чтобы вводить команды в консоль, так как терминал привязан к процессу, запущенному Docker’ом. Это и есть запуск на переднем плане. Если закрыть терминал, то контейнер будет остановлен. Если в данном случае добавить параметр `--rm`, то после завершения программы или после закрытия терминала контейнер будет удален.

{{% notice "note" %}}
Те же логи можно просматривать и в **Docker Desktop** во вкладке *Logs* раздела Containers. Эту вкладку можно найти, если нажать на название контейнера. Логи несут служебную информацию и вряд ли пригодятся рядовому пользователю Docker.
{{% /notice %}}

Логи представляют собой текстовые сообщения, которые посылаются программами в контейнере. Есть стандатные сообщения (например, о том, что программа запущена или выполнена) и сообщения об ошибках (например, ошибка из-за неверного формата файлов). Вывод стандартных сообщений и ошибок в окно консоли производится через разные потоки вывода, а именно поток стандартного вывода (*STDOUT*) и поток стандартных ошибок (*STDERR*), соответственно. На самом деле, сообщения, которые выводятся через поток ошибок не обязательно содержат ошибки, и два потока вывода нужны для только для удобства. По умолчанию режим переднего плана подразумевает, что в консольвыводятся сообщения из обоих потоков вывода.В зависимости от цели, которую вы преследуете, вы можете заставить docker выводить только сообщения об ошибках или только стандартные сообщения, а также получать сообщения из стандартного ввода. Для этого требуется использовать параметр `-a`:


    > docker run ... -a stdout -a stderr ...

Вы можете вписать один или несколько потоков, повторив параметр `-a` несколько раз.

Легко обнаружить, что при запуске `docker/getting-started` c выводом сообщений по `STDOUT`, выводятся только сообщения о запуске скриптов


    > docker run -a stdout -p 80:80 docker/getting-started

    /docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration

А при выводе только из `STDERR`, только сообщения о запуске процессов


    > docker run -a stderr -p 80:80 docker/getting-started

    2022/10/13 12:08:41 [notice] 1#1: start worker process 32
    ...[аналогичные сообщения]...

#### Передача данных в конвейер через поток стандартного ввода

Для работы некоторых приложения может потребоваться подать на вход текст, полученный из другой программы (через поток стандартного ввода *STDIN*) при помощи символа `|` (*pipe*). Чтобы сделать возможным получение данных из *STDIN*, необходимо упомянуть поток стандартного ввода в параметре `-a stdin`. В большинстве случаев, чтобы передать в контейнер данные из стандартного ввода придется также ввести параметр `-i`, который заставляет держать канал *STDIN* открытым, даже если контейнер не подключен к вводу (это задается создателем образа).

Продемонстрировать это можно, например, запуская программу cat, которая в Linux является стандартным средством просмотра текста через консоль, но в Windows эта программа отсутствует. Если ввести в консоль **PowerShell** команду


    > echo "Hello World!" | docker run --rm -i -a stdin -a stdout ubuntu cat

то Docker передаст тестовую строку “Hello World!” программе `cat`, запущеной в контейнере из образа `ubuntu` (содержит минимальный набор компонентов ОС Linux), через *STDIN*. В свою очередь, cat передаст полученный текст в окно консоли через *STDOUT*.

В терминале мы увидим сообщение


    Hello World!

    > 

Когда программа cat завершит выполнение, то контейнер будет удален благодаря параметру `--rm`.

#### Запуск контейнера в интерактивном режиме

Контейнер может содержать компоненты ядра операционной системы, а значит, в ряде случаев внутри контейнера можно будет запускать собственный терминал. Это напоминает работу в виртуальной машине. Чтобы запустить терминал, нужно запустить `docker run` с параметром `-t` и `-i` одновременно (часто пишут одним словом `-ti` или `-it`). Для примера, следующая команда открывает в PowerShell терминал Ubuntu:


    > docker run --rm -it ubuntu

В появившемся терминале можно вводить команды bash. Ниже я проверяю версию Ubuntu, обратившись к стандартному файлу os-ubuntu:

    > docker run --rm -it ubuntu

    root@df7701d1e063:/# cat /etc/os-release
    PRETTY_NAME="Ubuntu 22.04.1 LTS"
    NAME="Ubuntu"
    VERSION_ID="22.04"
    VERSION="22.04.1 LTS (Jammy Jellyfish)"
    VERSION_CODENAME=jammy
    ID=ubuntu
    ID_LIKE=debian
    HOME_URL="https://www.ubuntu.com/"
    SUPPORT_URL="https://help.ubuntu.com/"
    BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
    PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
    UBUNTU_CODENAME=jammy
    root@df7701d1e063:/#

{{% notice "warning" %}}
Запрещено вводить параметр -t, если контейнер получает данные через конвейер pipe (знак |).
{{% /notice %}}

#### Запуск команд внутри конвейера, запущенного в фоновом режиме

Если внутри конвейера есть компоненты ядра операционной системы, то можно запустить их при помощи терминала внутри ковейера. Запустить терминал можно из **Docker Desktop**, если в разделе *Containers*. Для этого нужно либо нажать на троеточие напротив названия терминала и выбрать *Open in terminal*, либо нажать на имя контейнера и открыть вкладку *CLI* (правый верхний угол экрана).

Если в запущеном контейнере есть программы, которые вы хотите запустить, то нужно воспользоваться командой


    > docker exec название_контейнера название_программы [аргументы]

Например, после запуска контейнера `ubuntu` можно запустить команду `cat /etc/os-release`, которая в Linux покажет версию операционной системы (то же самое, что показано в примере с запуском контейнера в интерактивном режиме:


    > docker run -d -i --name Ubuntu_container ubuntu

    3586325f911cd4a83600b08aff7e8e00d1c2ccf5bef5ce77b22a52fe38ccde1d

    > docker exec Ubuntu_container cat /etc/os-release

    PRETTY_NAME="Ubuntu 22.04.1 LTS"
    NAME="Ubuntu"
    VERSION_ID="22.04"
    VERSION="22.04.1 LTS (Jammy Jellyfish)"
    VERSION_CODENAME=jammy
    ID=ubuntu
    ID_LIKE=debian
    HOME_URL="https://www.ubuntu.com/"
    SUPPORT_URL="https://help.ubuntu.com/"
    BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
    PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
    UBUNTU_CODENAME=jammy

Первая команда запускает контейнер в фоновом режиме, при этом команда `-i` не позволит контейнеру остановиться, поскольку он будет ожитать ввода из *STDIN*.

Вторая команда запускает в контейнере нужную команду cat, которая выводит результат в *STDOUT*, то есть прямо в терминал.

#### Как удалить контейнер?

Удалить контейнер можно из окна docker в разделе `Containers`, нажатием на значок Delete (мусорный ящик) напротив названия контейнера. Либо в `PowerShell` можно ввести команду:


    > docker rm название_контейнера(или идентификатор)

После удаления контейнера все данные внутри контейнера будут удалены.

#### Как удалить образ контейнера?

После остановки контейнера, его можно удалить. Это можно сделать из окна docker в разделе `Images`. Для этого нужно нажать на значок троеточия напротив названия контейнера, затем выбрать `Remove`. Либо в `PowerShell` нужно ввести команду:


    > docker image rm название_образа(или идентификатор) 

#### Как переносить файлы между компьютером и контейнером?

Как уже говорилось, контейнер является полностью изолированной от операционной системы компьютера программой. При запуске контейнера docker создает отдельную файловую систему, и к файлам внутри контейнера невозможно обратиться при помощи стандартного файлового менеджера. Что нужно сделать, чтобы быстро и легко переносить данные из локальной машины в файловую систему компьютера?

Самый простой способ - привязать *(bind)* к контейнеру какую-нибудь папку на локальной машине. Принцип действия очень простой: при запуске контейнера внутри его файловой системы создается директория, которая привязывается к папке на компьютере. Любые изменения, любые новые файлы, внесенные в этой директории контейнера, автоматически отобразатся в папке на компьютере (и наоборот).

Чтобы привязать папку на компьютере к директории в контейнере (смонтировать Том), нужно добавить к команде `docker run` параметр `-v [путь к папке на компьютере]:[путь к директории контейнера]`. Обратите внимание, что путь к папке и путь к директории разделены двоеточием. Однако двоеточие есть в путях к папкам в ОС Windows. Поэтому чтобы вводить в параметр путь к папкам Windows, нужно стандартный адрес папок модифицировать как показано ниже:

| Адрес папки в Windows         | Адрес, который нужно ввести |
|-------------------------------|-----------------------------|
| C:\\Docker\\myContainer\\data | //c/Docker/myContainer/data |

Обратите внимание:

1)  Все обратные слэши (\\) были заменены на прямые (/)
2)  Название диска (С) написано строчной буквой (с)
3)  Вместо двоеточия после названия диска (C:) пишется двойной слеш перед названием диска (//c)

Допустим, вы хотите, чтобы на компьютере с Windows Том располагался в папке “C:\\Docker\\myContainer\\data”. В контейнере, содержащем ядро Linux, этому тому будет соответствовать директория “/data”. команда, монтирующая том будет выглядеть следующим образом:


    > docker run ... -v //c/Docker/myContainer/data:/data ...

Если вы хотите смонтировать несколько папок, то можно воспользоваться параметром `-v` несколько раз:


    > docker run ... -v //c/Docker/myContainer/data:/data -v //e/Docker/second_dir:/secondDir ...

Обратите внимание, что название папки на компьютере и директории в контейнере может не совпадать.

Более продвинутый способ - создать на компьютере *Том (Volume)*. Тома - это файлы или каталоги, которые смонтированы непосредственно на хосте и не являются частью файловой системы контейнера. По определению, том — это файловая система, которая расположена на хост-машине за пределами контейнеров. По сути том - это папка внутри Docker Desktop путь к которой будет записан в памяти docker в виде переменной.

Создать том можно двумя способами:
1. В разделе Volumes программы **Docker Desktop** нажать кнопку *Create* (правый верхний угол) и ввести какое-нибудь название.

2.  В терминале (Cmd или PowerShell) ввести команду

<!-- -->


    > docker volume create название_тома

Вы можете найти эту папку при помощи файлового менеджера. Путь к папке, в которой лежат Томы в Windows 11 находится по адресу `\\wsl.localhost\docker-desktop-data\data\docker\volumes`. Его можно ввести в адресную строку проводника:

![Volume](/Programs/Docker.files/Volume.png?width=20pc)

На скриншоте выше показно, как это может выглядеть. Обратите внимание, в проводнике **Explorer** в левой части экрана располагается панель быстрого доступа, где можно увидеть смонтированные при помощи WSL2 разделы `docker-desktop` и `docker-desktop-data`, которые появляются после установки **Docker Desktop**. В разделе `docker-desktop-data` - в указанной выше директории - и хранятся тома. На скриншоте показано, что помимо служебных файлов в этой диркетории лежит папка `my_vol`. Это название универсального тома, который был создан командой `docker volume create my_vol`. В этой папке лежит несколько служебных папок, а также папка `_data`. Собственно, содержимое последней папки и будет синхронизироваться с разделами контейнеров.

Для примера, в эту папку были скопированы несколько файлов: текстовый файл `1.txt`, HiC карта `dixon.mcool`, а также изображение `program.png`. После копирования, появилось еще несколько служебных файлов, которые для нас не важны. Просмотреть содержимое тома `my_vol` можено в разделе *Volumes* в **Docker Desktop**, если нажать на название тома и выбрать вкладку `DATA`.

![Volume1](/Programs/Docker.files/Volume2.png?width=20pc)
![Volume2](/Programs/Docker.files/Volume1.png?width=20pc)
![Volume3](/Programs/Docker.files/Volume3.png?width=20pc)

После создания тома его можно привязывать к нескольким контейнерам, просто указав название тома перед названием директории в контейнере в параметре `-v`


    > docker run ... -v my_vol:/data ...

Удалить том можно в разделе *Volumes* в **Docker Desktop** (значок корзины) либо в терминале при помощи команды


    > docker volume rm название_тома

Узнать список всех томов на компьютере можно в разделе *Volumes* в **Docker Desktop** либо в терминале при помощи команды


    > docker volume ls

#### Как копировать файлы в контейнер и из него?

Если вы хотите напрямую скопировать файлы из вашей хост-системы в контейнер, вы должны использовать команду `docker cp` к терминале (**Cmd** или **PowerShell**), например:


    > docker cp путь_к_файлу_на_компьютере название_контейнера:путь_назначения_в_контейнере

Это работает и в обратную сторону:


    > docker cp название_контейнера:путь_к_файлу_в_контейнере путь_назначения_на_компьютере

### Литература

[Милл Иан, Сейерс Эйдан Хобсон - Docker на практике (2020)](https://drive.google.com/file/d/1BYH8Lh46ZWtInXYYRncr4oqjXhMMHa8n/view?usp=sharing)

[Эдриен Моуэт - Использование Docker (2017)](https://drive.google.com/file/d/136mEKfg2tM3alMeqSdD4vCt9iqheBSTb/view?usp=sharing)

### Документация

[Официальная документация](https://docs.docker.com/)
[Русская версия документации](https://dker.ru/docs/)
[Видеоуроки](https://youtube.com/playlist?list=PLD5U-C5KK50XMCBkY0U-NLzglcRHzOwAg)
[Инструкция по установке на Windows с
WSL2](https://tretyakov.net/post/ustanovit-docker-na-windows-10-wsl2/)
[Еще одна инструкция по установке на Windows с
WSL2](https://ip-calculator.ru/blog/ask/ustanovka-docker-na-windows-10-home/)
