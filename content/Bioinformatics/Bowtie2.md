---
title: "Bowtie2"
author: "Romanov Stanislav"
date: "20 01 2022"
output: html_document
lang: russian
tags: ["bowtie2", "bowtie", "Множественное выравнивание", "ChIP-seq", "Fastq alignment"]
---

[Bowtie 2](http://bowtie-bio.sourceforge.net/bowtie2/index.shtml) — это наиболее популярный инструмент для выравнивания коротких фрагментов ДНК на эталонные последовательности. Он особенно хорош для выравнивания ридов длиной от 50 до 100-1000bp на длинные референсные геномы (в т.ч. млекопитающих). Достаточно высокая скорость и эффективное использование оперативной памяти в Bowtie 2 достигается за счет преобразования генома в матрицу ссылочных последовательностей с помощью [FM-индекса](http://en.wikipedia.org/wiki/FM-index) (на основе [преобразования Барроуза — Уилера](https://mf.grsu.by/UchProc/livak/po/comprsite/theory_bwt.html), [*Burrows-Wheeler transform*](https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5_%D0%91%D0%B0%D1%80%D1%80%D0%BE%D1%83%D0%B7%D0%B0_%E2%80%94_%D0%A3%D0%B8%D0%BB%D0%B5%D1%80%D0%B0#:~:text=%D0%9F%D1%80%D0%B5%D0%BE%D0%B1%D1%80%D0%B0%D0%B7%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20%D0%91%D0%B0%D1%80%D1%80%D0%BE%D1%83%D0%B7%D0%B0%20%E2%80%94%20%D0%A3%D0%B8%D0%BB%D0%B5%D1%80%D0%B0%20(Burrows%2D,BWT%20%D0%B8%D1%81%D0%BF%D0%BE%D0%BB%D1%8C%D0%B7%D1%83%D0%B5%D1%82%D1%81%D1%8F%20%D0%B2%20%D0%B0%D1%80%D1%85%D0%B8%D0%B2%D0%B0%D1%82%D0%BE%D1%80%D0%B5%20bzip2.),%20*BWT*). Bowtie2 поддерживает режимы выравнивания с пропусками *(gapped alignment)*, локальное выравнивание *(local alignment)* и выравнивание парных ридов *(paired-end alignment)*. Доступен для *Linux* и *OSX*.

{{% notice "warning" %}}
Не следует путать bowtie2 с bowtie. Хотя последний инструмент является предшественником bowtie2, в нем имеется ряд недостатков: отсутствует возможность локального выравнивания (то есть все риды должны выравниваниваться полностью от начала до конца), режим выравнивания парных ридов ограничен и не предназначен для выравнивания дискордантных ридов, отсутсвует поддержка вырожденных символов (например, N). Bowtie обладает низкой эффективностью при выравнивании ридов длинее 50 пар и не способен выравнивать риды длинее 1000 пар. Важно понимать, что геномные индексы, произведенные Bowtie2 и Bowtie взаимозаменяемы только начиная с версии Bowtie v1.2.3.
{{% /notice %}}

### Референсные публикации

-   Langmead B, Wilks C, Antonescu V, Charles R. [Scaling read aligners to hundreds of threads on general-purpose processors](https://doi.org/10.1093/bioinformatics/bty648). *Bioinformatics*. 2018 Jul 18. doi: 10.1093/bioinformatics/bty648.

-   Langmead B, Salzberg SL. [Fast gapped-read alignment with Bowtie 2](https://www.nature.com/articles/nmeth.1923). *Nature Methods*. 2012 Mar 4;9(4):357-9. doi: 10.1038/nmeth.1923.

### Официальные материалы

-   [Официальный сайт](http://bowtie-bio.sourceforge.net/bowtie2/index.shtml)

-   Расширенный [мануал](http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml)

-   Список [приложений](http://bowtie-bio.sourceforge.net/bowtie2/other_tools.shtml), использующих Bowtie2

-   Архив [геномных индексов](https://benlangmead.github.io/aws-indexes/bowtie) Bowtie2 и Bowtie

### Принцип работы

Подробно о алгоритме преобразования BWT, FM-индексе и связанных с этим алгоритмах можно познакомиться в [видео-лекции](https://www.youtube.com/watch?v=P3ORBMon8aw), [презентации](https://www.cs.jhu.edu/~langmea/resources/lecture_notes/bwt_and_fm_index.pdf) или [учебнике](https://www.cs.cmu.edu/~15451-f18/lectures/lec25-bwt.pdf).

Если говорить подробно, то для каждого рида Bowtie2 производит вычисления в четыре шага. На шаге 1 ***(Extract seed)*** Bowtie2 извлекает из рида и комплементарной к нему последовательности (не путать с *mait-pair*) “затравочные” подстроки (*seeds*). На шаге 2 **(*Align with FM-Index*)** затравочные подстроки выравниваются на референсный геном без пропусков (*ungapped, без делеций и инсерций*) с использованием FM-индекса, в результате чего получаются интервалы Барроуза-Уиллера *(BW ranges),* которые указывают на строки в матрице, полученной путем трансформации генома с помощью BWT. На шаге 3 ***(Prioritize, resolve)*** Bowtie2 извлекает из BW-матрицы строки, соответствующие полученным интервалам, и каждая строка приобретает приоритет *(prioritize)*, при этом чем меньше интервал - тем выше приоритет. Далее, учитывая приоритет строк, с помощью FM-индекса и алгоритма “walk-left” Bowtie2 определяется смещение *([offset](https://ru.wikipedia.org/wiki/%D0%A1%D0%BC%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5_(%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B8%D0%BA%D0%B0)#:~:text=%D0%92%20%D0%B8%D0%BD%D1%84%D0%BE%D1%80%D0%BC%D0%B0%D1%82%D0%B8%D0%BA%D0%B5%2C%20%D1%81%D0%BC%D0%B5%D1%89%D0%B5%D0%BD%D0%B8%D0%B5%20%D0%B2%D0%BD%D1%83%D1%82%D1%80%D0%B8%20%D0%BC%D0%B0%D1%81%D1%81%D0%B8%D0%B2%D0%B0,%D0%BE%D0%B4%D0%BD%D0%BE%D0%B3%D0%BE%20%D0%B8%20%D1%82%D0%BE%D0%B3%D0%BE%20%D0%B6%D0%B5%20%D0%BE%D0%B1%D1%8A%D0%B5%D0%BA%D1%82%D0%B0.))* выбранных строк, и таким образом получает координаты затравочных последовательностей в геноме *(Extention candidates).* Иными словами, Bowtie2 разрешает *(resolve)* затравочные выравнивания. На шаге 4 *(**Extend**)* Bowtie2 берет приоритетные разрешенные затравочные выравнивания из шага 3 и расширяет выравнивание рида на всю окрестность вблизи затравки. Выравнивание на данном этапе ускоряется за счет использования динамического программирования SIMD ([Single Instruction Multiple Data](https://ru.wikipedia.org/wiki/SIMD)). Выравнивание продолжается до тех пор, пока не будут проанализированы все разрешенные затравки *(seed hits)*, пока не будет изучено достаточное количество выравниваний, или пока не будет достигнут предел трудоемкости *(effort limit)* динамического программирования.

![](/Bioinformatics/Bowtie2.files/workflow.png?width=40pc)

Если кратко, то сначала каждый рид и комплементарная к нему последовательность разбивается на затравочные подстроки *(seed)*. Затем извлеченные подстроки выравниваются на референсный геном без пропусков *(seed alignment)* и расставляются по приоритету *(prioritize)*. На последнем этапе затравочные выравнивания расширяются на весь рид.

В результате для каждого рида получается множество выравниваний. Чтобы выбрать наилучшее выравнивание Bowtie2 вычисляет для каждого из них оценку выравнивания *(alignment score).* Оценка количественно определяет, насколько рид похож на референсную последовательность. Чем выше балл - тем лучше. Оценка рассчитывается путем вычитания штрафов *(penalty)* за каждое отличие: замены *(mismatch)*, пропуски *(gap),* наличие вырожденных символов *(ambigous characters)*. В режиме локального выравнивания, за каждое совпадение к оценке добавляется бонус *(bonus)*. Результат выравнивания оформляется в формате [SAM](https://ru.wikipedia.org/wiki/SAMtools) в поток стандартного вывода 1 *(“stdout”),* если не указан файл назначения. Дополнительная информация, предупреждения и статистика выравнивания выводятся в стандартный поток номер 2 *(“stderr”).*

### Установка

Подробное описание способов установки можно посмотреть [здесь](https://www.metagenomics.wiki/tools/bowtie2/install)

Наиболее простой способ - установить с помощью Anaconda:

``` toml
conda install -c bioconda bowtie2
```

### Инструменты Bowtie2

После установки Bowtie2 пользователю становится доступно несколько инструментов:

1.  `bowtie2`, `bowtie2-align-s` и `bowtie2-align-l` осуществляют выравнивание коротких последовательностей (в формате fastq, fasta и др.) на **индексированный** референсный геном/последовательность. `bowtie2-align-s` и `bowtie2-align-l` представляют собой бинарный код для выравнивания на индексы малого (small) и большого (large) формата. `bowtie2` является сценарием-оберткой *(wrapper)*, запускающим `bowtie2-align-s/l` в зависимости от формата индекса и дающий дополнительные возможности, в частности, работу со сжатыми файлами. По-сути всегда нужно использовать `bowtie2`.
2.  `bowtie2-build`, `bowtie2-build-s`, и `bowtie2-build-l` осуществляют индексирование генома (файл в формате fasta или последовательности из командной строки). Как и в прошлом пункте, `bowtie2-build` представляет собой обортку для запуска бинарных команд `bowtie2-build-s`, и `bowtie2-build-l`. Для геномов длиной менее 4 миллиардов нуклеотидов bowtie2-build строит “малый” индекс, используя 32-битные числа в различных частях индекса. Если геном длиннее, `bowtie2-build` строит “большой” индекс, используя 64-битные числа. Малые индексы хранятся в файлах с расширением **.bt2**, а большие - в файлах с расширением **.bt2l**. Пользователю не нужно беспокоиться о том, является ли конкретный индекс малым или большим, так как обертки автоматически построят и используют соответствующий индекс.
3.  `bowtie2-inspect`, `bowtie2-inspect-s` `bowtie2-inspect-l` извлекают из индекса Bowtie2 информацию о том, что это за индекс и какие референсные последовательности использовались для его построения. При запуске без каких-либо параметров инструмент выведет [`FASTA`](https://en.wikipedia.org/wiki/FASTA) файл, содержащий последовательности референсов (все символы кроме `A`/`C`/`G`/`T` будут преобразованы в `N`).

### Индексирование генома с помощью bowtie2-build

{{% notice "note" %}}
Готовые геномные индексы можно скачать с оффициального сайта bowtie-bio.sourceforge.net
{{% /notice %}}

[Подробный мануал](http://bowtie-bio.sourceforge.net/bowtie2/manual.shtml#the-bowtie2-build-indexer)

Обычно в качестве референса предоставляется fasta-файл. Вслед за fasta-файлом требуется префикс для файлов индексированного референса:

``` bash
bowtie2-build -f путь_к_fasta Префикс
```

Параметр `-f` не обязателен. Он указывает, что рефернс представляет из себя fasta-файл. Можно предоставлять список fasta-файлов через запятую без пробелов:

``` bash
bowtie2-build -f путь_к_fasta_1,путь_к_fasta_2,путь_к_fasta_3 Префикс
```

Вместо Fasta-файла может быть список последовательностей через запятую без пробелов:

``` bash
bowtie2-build -c GGTCATCCT,ACGGGTCGT,CCGTTCTATGCGGCTTA Префикс
```

В результате программа выдаст шесть файлов с названиями `Префикс.1.bt2`, `Префикс.2.bt2`, `Префикс.3.bt2`, `Префикс.4.bt2`, `Префикс.rev.1.bt2` и `Префикс.rev.2.bt2`. Если префикс не указать, то префикс будет `NAME.`. В случае, если индексы большие, вместо `.bt2` расширение файла будет `.bt21`.

{{% notice "note" %}}
Файлы индексированного референса будут сохранены в директории, из которой была вызвана программа bowtie2-build
{{% /notice %}}

Для ускоренного индексирования следует активировать многопоточный режим, добавив параметр `–treads n`.

``` bash
bowtie2-build --threads 25 -f путь_к_fasta Префикс
```

### Режимы выравнивания

### Рецепты
